import streamlit as st
import pandas as pd
from datetime import datetime, timedelta
from zoneinfo import ZoneInfo
from growwapi import GrowwAPI
import numpy as np
from functools import lru_cache
import subprocess
import sys
import os

# 1) Page setup + header
st.set_page_config(page_title="Trading Signal Predictor", layout="wide")
st.title("ğŸ“ˆ Trading Signal Predictor")
st.write("ğŸ”„ Initializingâ€¦")

# === Guide Page Renderer ===
def show_guide():
    st.title("ğŸ“˜ Strategy Guide â€“ Signal Confidence Strength")
    st.markdown("""
    This section explains how to interpret the **confidence score** and resulting labels generated by the trading signal model.

    ### ğŸ” How Confidence Works:
    - The model outputs a probability that a candle is a **BUY signal**.
    - We translate this into **labels** for human-friendly interpretation.

    ---

    ### ğŸ§  Confidence Strength Breakdown

    | Confidence %       | Label              | Meaning                                  |
    |--------------------|--------------------|------------------------------------------|
    | **90â€“100%**        | ğŸ”¥ Strong BUY      | Very high conviction â€” ideal entry zone. |
    | **70â€“89.99%**      | âœ… Moderate BUY    | Good signal, with decent model backing.  |
    | **50â€“69.99%**      | âš ï¸ Weak BUY        | Slight positive bias â€” wait for confirmation. |
    | **30â€“49.99%**      | âš ï¸ Weak SELL       | Slight negative bias â€” stay cautious.    |
    | **10â€“29.99%**      | âŒ Moderate SELL   | Selling pressure likely â€” avoid buying.  |
    | **0â€“9.99%**        | ğŸ’€ Strong SELL     | Very bearish â€” exit or short if applicable. |

    ---

    ### ğŸ’¡ Tips:
    - Combine this with technical indicators (RSI, MACD) for better decisions.
    - Use **Strong BUY** or **Strong SELL** as clear entry/exit zones.
    - For **Weak signals**, observe next candles or add filters.
    ---
    """)

# 2) Auth
st.sidebar.title("ğŸ” Groww API Auth")
api_key = st.sidebar.text_input("Enter your Groww API token", type="password")
st.write("ğŸ”‘ API key present?", bool(api_key))
if not api_key:
    st.warning("Please enter your Groww API token in the sidebar.")
    st.stop()

groww = GrowwAPI(api_key)

# === Navigation Control ===
page = st.sidebar.radio("ğŸ“š Page", ["ğŸ“ˆ Live Signal", "ğŸ“˜ Strategy Guide"])

if page == "ğŸ“˜ Strategy Guide":
    show_guide()
    st.stop()

# 3) Load instruments.csv with explicit dtype handling
@lru_cache(maxsize=1)
def load_instruments():
    try:
        df = pd.read_csv("instruments.csv", low_memory=False)
        st.write("âœ… Loaded instruments.csv:", df.shape)
    except Exception as e:
        st.error(f"âŒ instruments.csv load failed: {e}")
        raise
    groww.instruments = df
    groww._load_instruments = lambda: None
    groww._download_and_load_instruments = lambda: df
    groww.get_instrument_by_groww_symbol = (
        lambda sym: df[df['groww_symbol'] == sym].iloc[0].to_dict()
    )
    return df

try:
    instruments_df = load_instruments()
except:
    st.stop()

# 4) Load ML models
try:
    from strategy_1_model import buy_model, rr_model, compute_rsi
    st.write("âœ… Models imported successfully")
except Exception as e:
    st.error(f"âŒ Model import error: {e}")
    st.stop()

# 5) Time setup
start_time_ist = datetime(2025, 6, 10, 9, 15, tzinfo=ZoneInfo("Asia/Kolkata"))
end_time_ist = datetime.now(ZoneInfo("Asia/Kolkata"))
now_ist = end_time_ist

# 6) Auto-refresh during market hours
if datetime.strptime("09:15", "%H:%M").time() <= now_ist.time() <= datetime.strptime("15:30", "%H:%M").time():
    st.markdown("<meta http-equiv='refresh' content='600'>", unsafe_allow_html=True)

# 7) Strategy selector (reserved for future)
st.sidebar.selectbox("Select Strategy Version", ["Strategy 1"])

# 8) Live prediction logic with step-by-step logging
def live_predict(symbol="NSE-NIFTY", interval_minutes=10):
    st.subheader("ğŸ“¡ Fetching live data")
    st.write("â€¢ Symbol:", symbol)
    st.write("â€¢ Interval:", interval_minutes, "mins")

    try:
        sel = groww.get_instrument_by_groww_symbol(symbol)
        st.write("ğŸ§¾ Instrument:", sel)
    except Exception as e:
        st.error(f"âŒ Instrument lookup failed: {e}")
        return

    try:
        raw = groww.get_historical_candle_data(
            trading_symbol=sel['trading_symbol'],
            exchange=sel['exchange'],
            segment=sel['segment'],
            start_time=start_time_ist.strftime("%Y-%m-%d %H:%M:%S"),
            end_time=end_time_ist.strftime("%Y-%m-%d %H:%M:%S"),
            interval_in_minutes=interval_minutes
        )
        st.write("ğŸ“¡ Raw Groww response:", raw)
    except Exception as e:
        st.error(f"âŒ API call error: {e}")
        return

    candles = raw.get('candles') if isinstance(raw, dict) else None
    st.write("ğŸ“Š Candle count:", len(candles) if candles else 0)

    if not candles:
        st.error("âš ï¸ No candle data returned.")
        return

    df = pd.DataFrame(candles, columns=['timestamp','open','high','low','close','volume'])
    df['timestamp'] = (
        pd.to_datetime(df['timestamp'], unit='s', utc=True)
          .dt.tz_convert('Asia/Kolkata')
    )
    df.sort_values('timestamp', inplace=True)
    df.reset_index(drop=True, inplace=True)

    df['SMA_10'] = df['close'].rolling(10).mean()
    df['EMA_10'] = df['close'].ewm(span=10, adjust=False).mean()
    df['Momentum'] = df['close'] - df['close'].shift(10)
    df['Volatility'] = df['close'].rolling(10).std()
    df['RSI'] = compute_rsi(df['close'])

    latest = df[['SMA_10','EMA_10','RSI','Momentum','Volatility']].dropna().tail(1)
    if latest.empty:
        st.warning("Not enough data to predict.")
        return

    try:
        proba = buy_model.predict_proba(latest)[0]
        rr_val = rr_model.predict(latest)[0]
    except Exception as e:
        st.error(f"âŒ Prediction error: {e}")
        return

    conf = proba[1]*100
    buy = proba[1] > 0.5

    st.subheader("ğŸ“ˆ Prediction")
    st.write("â€¢ Last candle:", df['timestamp'].iloc[-1])
    st.write("â€¢ Signal:", "BUY" if buy else "HOLD/SELL")
    st.write(f"â€¢ Confidence: {conf:.2f}%")
    st.write(f"â€¢ Risk/Reward: {rr_val:.4f}")
    st.dataframe(df.tail(10), use_container_width=True)

    next_time = df['timestamp'].iloc[-1] + timedelta(minutes=interval_minutes)
    rem = next_time - datetime.now(ZoneInfo("Asia/Kolkata"))
    st.info(f"â³ Next candle in: {rem.seconds//60}m {rem.seconds%60}s")

# ğŸ› ï¸ 9) Sidebar Prediction Trigger
if st.sidebar.button("â–¶ Run Live Prediction"):
    live_predict()

# ğŸ” 10) Retrain
st.sidebar.markdown("### ğŸ§  Retrain")
if st.sidebar.button("ğŸ” Retrain Model"):
    st.info("ğŸ“¡ Retrainingâ€¦")
    try:
        p = subprocess.Popen([sys.executable, "strategy_1_retrain.py"],
                             stdout=subprocess.PIPE, stderr=subprocess.STDOUT,
                             universal_newlines=True)
        out = st.empty()
        log = ""
        for line in p.stdout:
            log += line
            out.code(log)
        p.wait()
        if p.returncode == 0:
            st.success("âœ… Retraining complete!")
            st.experimental_rerun()
        else:
            st.error("âŒ Retraining failed.")
    except Exception as e:
        st.error(f"âŒ Retrain error: {e}")

# ğŸ”ƒ 11) Manual Refresh
if st.button("ğŸ”ƒ Refresh Now"):
    st.experimental_rerun()
